<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyfence - Customer Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FDB813;
            --primary-dark: #e5a700;
            --secondary: #404040;
            --accent: #2D2D2D;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            box-sizing: border-box;
            font-family: 'Sarabun', sans-serif;
            margin: 0;
            padding: 0;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(145deg, #f5f5f5 0%, #e8e8e8 100%);
        }

        .header {
            display: flex;
            align-items: center;
            padding: 1rem 2rem;
            background: white;
            box-shadow: var(--shadow);
        }

        .logo {
            height: 40px;
            margin-right: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #eee;
            border-radius: 8px;
            margin-top: 0.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--accent);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .table th, .table td {
            padding: 0.75rem;
            border: 1px solid #dee2e6;
        }

        .table th {
            background: #f8f9fa;
        }

        .tab-container {
            margin-bottom: 1rem;
        }

        .tab-button {
            padding: 0.5rem 1rem;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            margin-right: 0.5rem;
        }

        .tab-button.active {
            background: var(--primary);
            color: var(--accent);
        }

        .tab-content {
            display: none;
            padding: 1rem;
            background: white;
            border-radius: 0 0 4px 4px;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://www.cyfence.com/wp-content/uploads/2021/09/%E0%B8%A5%E0%B8%87%E0%B9%80%E0%B8%A7%E0%B9%87%E0%B8%9A%E0%B9%83%E0%B8%AB%E0%B8%A1%E0%B9%88.jpg" alt="Cyfence Logo" class="logo">
        <h1>ระบบจัดการข้อมูลลูกค้า</h1>
    </div>

    <div class="container">
        <div id="mainContent" style="display: none;">
        <div class="card">
            <div class="tab-container">
                <button class="tab-button active" onclick="openTab(event, 'shifts')">Shifts</button>
                <button class="tab-button" onclick="openTab(event, 'companies')">บริษัท</button>
                <button class="tab-button" onclick="openTab(event, 'mappings')">การจับคู่ชื่อ</button>
            </div>
        </div>

            <!-- Shifts Tab -->
            <div id="shifts" class="tab-content active">
                <h2>จัดการ Shifts</h2>
                <div class="form-group">
                    <label>Shift Number:</label>
                    <input type="text" id="shiftNumber" class="form-control" placeholder="เช่น Shift 1">
                </div>
                <div class="form-group">
                    <label>บริษัท (คั่นด้วยเครื่องหมาย ,):</label>
                    <input type="text" id="shiftCompanies" class="form-control" placeholder="เช่น MSIG,TCRB,TVI">
                </div>
                <button onclick="saveShift()" class="btn btn-primary">บันทึก Shift</button>
                <table class="table" id="shiftsTable">
                    <thead>
                        <tr>
                            <th>Shift</th>
                            <th>บริษัท</th>
                            <th>การจัดการ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Companies Tab -->
            <div id="companies" class="tab-content">
                <h2>จัดการข้อมูลบริษัท</h2>
                <div class="form-group">
                    <label>รหัสบริษัท:</label>
                    <input type="text" id="companyCode" class="form-control" placeholder="เช่น MSIG">
                </div>
                <div class="form-group">
                    <label>ประเภทบริษัท:</label>
                    <select id="companyType" class="form-control">
                        <option value="company">บริษัททั่วไป</option>
                        <option value="hospital">โรงพยาบาล</option>
                        <option value="government">หน่วยงานรัฐ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ชื่อเต็มบริษัท:</label>
                    <input type="text" id="companyFullName" class="form-control" placeholder="เช่น เจ้าหน้าที่ MSIG">
                </div>
                <button onclick="saveCompany()" class="btn btn-primary">บันทึกข้อมูลบริษัท</button>
                <table class="table" id="companiesTable">
                    <thead>
                        <tr>
                            <th>รหัสบริษัท</th>
                            <th>ประเภท</th>
                            <th>ชื่อเต็ม</th>
                            <th>การจัดการ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Mappings Tab -->
            <div id="mappings" class="tab-content">
                <h2>จัดการการจับคู่ชื่อ</h2>
                <div class="form-group">
                    <label>ชื่อที่แสดงในระบบ:</label>
                    <input type="text" id="displayName" class="form-control" placeholder="เช่น บริษัท MSIG ประกันภัย จำกัด">
                </div>
                <div class="form-group">
                    <label>รหัสบริษัท:</label>
                    <input type="text" id="mappingCompanyCode" class="form-control" placeholder="เช่น MSIG">
                </div>
                <button onclick="saveMapping()" class="btn btn-primary">บันทึกการจับคู่</button>
                <table class="table" id="mappingsTable">
                    <thead>
                        <tr>
                            <th>ชื่อที่แสดง</th>
                            <th>รหัสบริษัท</th>
                            <th>การจัดการ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script>
        // Initialize Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyAcb9q1eX1QM9Gl_W6U9WZNbeg6M-uyhpk",
            authDomain: "cyfencedevbyken.firebaseapp.com",
            projectId: "cyfencedevbyken",
            storageBucket: "cyfencedevbyken.appspot.com",
            messagingSenderId: "632813871756",
            appId: "1:632813871756:web:57d674643f258ddd2e11a9",
        });

        const db = firebase.firestore();

        // Tab Management
        function openTab(evt, tabName) {
            const tabcontents = document.getElementsByClassName("tab-content");
            for (let content of tabcontents) {
                content.classList.remove("active");
            }

            const tabButtons = document.getElementsByClassName("tab-button");
            for (let button of tabButtons) {
                button.classList.remove("active");
            }

            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // Shifts Management
        async function saveShift() {
            const shiftNumber = document.getElementById('shiftNumber').value;
            const companies = document.getElementById('shiftCompanies').value.split(',').map(c => c.trim());
            
            try {
                await db.collection('shifts').doc(shiftNumber).set({
                    name: shiftNumber,
                    companies: companies
                });
                alert('บันทึก Shift สำเร็จ');
                loadShifts();
            } catch (error) {
                alert('เกิดข้อผิดพลาด: ' + error.message);
            }
        }

        async function loadShifts() {
            const shiftsTable = document.querySelector('#shiftsTable tbody');
            shiftsTable.innerHTML = '';
            
            const snapshot = await db.collection('shifts').get();
            snapshot.forEach(doc => {
                const shift = doc.data();
                const row = `
                    <tr>
                        <td>${shift.name}</td>
                        <td>${shift.companies.join(', ')}</td>
                        <td>
                            <button onclick="deleteShift('${doc.id}')" class="btn btn-danger">ลบ</button>
                        </td>
                    </tr>
                `;
                shiftsTable.innerHTML += row;
            });
        }

        async function deleteShift(shiftId) {
            if (confirm('ต้องการลบ Shift นี้ใช่หรือไม่?')) {
                try {
                    await db.collection('shifts').doc(shiftId).delete();
                    alert('ลบ Shift สำเร็จ');
                    loadShifts();
                } catch (error) {
                    alert('เกิดข้อผิดพลาด: ' + error.message);
                }
            }
        }

        // Companies Management
        async function saveCompany() {
            const code = document.getElementById('companyCode').value;
            const type = document.getElementById('companyType').value;
            const fullName = document.getElementById('companyFullName').value;
            
            try {
                await db.collection('companies').doc(code).set({
                    code: code,
                    type: type,
                    fullName: fullName
                });
                alert('บันทึกข้อมูลบริษัทสำเร็จ');
                loadCompanies();
            } catch (error) {
                alert('เกิดข้อผิดพลาด: ' + error.message);
            }
        }

        async function loadCompanies() {
            const companiesTable = document.querySelector('#companiesTable tbody');
            companiesTable.innerHTML = '';
            
            const snapshot = await db.collection('companies').get();
            snapshot.forEach(doc => {
                const company = doc.data();
                const row = `
                    <tr>
                        <td>${company.code}</td>
                        <td>${company.type}</td>
                        <td>${company.fullName}</td>
                        <td>
                            <button onclick="deleteCompany('${doc.id}')" class="btn btn-danger">ลบ</button>
                        </td>
                    </tr>
                `;
                companiesTable.innerHTML += row;
            });
        }

        async function deleteCompany(companyId) {
            if (confirm('ต้องการลบข้อมูลบริษัทนี้ใช่หรือไม่?')) {
                try {
                    await db.collection('companies').doc(companyId).delete();
                    alert('ลบข้อมูลบริษัทสำเร็จ');
                    loadCompanies();
                } catch (error) {
                    alert('เกิดข้อผิดพลาด: ' + error.message);
                }
            }
        }

        // Mappings Management
        async function saveMapping() {
            const displayName = document.getElementById('displayName').value;
            const companyCode = document.getElementById('mappingCompanyCode').value;
            
            try {
                await db.collection('mappings').doc(displayName).set({
                    displayName: displayName,
                    companyCode: companyCode
                });
                alert('บันทึกการจับคู่สำเร็จ');
                loadMappings();
            } catch (error) {
                alert('เกิดข้อผิดพลาด: ' + error.message);
            }
        }

        async function loadMappings() {
            const mappingsTable = document.querySelector('#mappingsTable tbody');
            mappingsTable.innerHTML = '';
            
            const snapshot = await db.collection('mappings').get();
            snapshot.forEach(doc => {
                const mapping = doc.data();
                const row = `
                    <tr>
                        <td>${mapping.displayName}</td>
                        <td>${mapping.companyCode}</td>
                        <td>
                            <button onclick="deleteMapping('${doc.id}')" class="btn btn-danger">ลบ</button>
                        </td>
                    </tr>
                `;
                mappingsTable.innerHTML += row;
            });
        }

        async function deleteMapping(mappingId) {
            if (confirm('ต้องการลบการจับคู่นี้ใช่หรือไม่?')) {
                try {
                    await db.collection('mappings').doc(mappingId).delete();
                    alert('ลบการจับคู่สำเร็จ');
                    loadMappings();
                } catch (error) {
                    alert('เกิดข้อผิดพลาด: ' + error.message);
                }
            }
        }

        // Authentication Check
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    const userData = userDoc.data();
                    
                    if (userData?.role !== 'admin') {
                        alert('คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
                        window.location.href = 'dashboard.html';
                    } else {
                        // Load all data when authenticated
                        loadShifts();
                        loadCompanies();
                        loadMappings();
                        document.getElementById('mainContent').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    alert('เกิดข้อผิดพลาดในการตรวจสอบสิทธิ์');
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        // Export functionality
        async function exportConfiguration() {
            try {
                const config = {
                    shifts: {},
                    companies: {},
                    mappings: {}
                };

                // Get shifts
                const shiftsSnapshot = await db.collection('shifts').get();
                shiftsSnapshot.forEach(doc => {
                    config.shifts[doc.id] = doc.data();
                });

                // Get companies
                const companiesSnapshot = await db.collection('companies').get();
                companiesSnapshot.forEach(doc => {
                    config.companies[doc.id] = doc.data();
                });

                // Get mappings
                const mappingsSnapshot = await db.collection('mappings').get();
                mappingsSnapshot.forEach(doc => {
                    config.mappings[doc.id] = doc.data();
                });

                // Create and download config file
                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'customer-config.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('เกิดข้อผิดพลาดในการ export: ' + error.message);
            }
        }

        // Import functionality
        async function importConfiguration(file) {
            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const config = JSON.parse(e.target.result);
                        
                        // Import shifts
                        for (const [id, data] of Object.entries(config.shifts)) {
                            await db.collection('shifts').doc(id).set(data);
                        }
                        
                        // Import companies
                        for (const [id, data] of Object.entries(config.companies)) {
                            await db.collection('companies').doc(id).set(data);
                        }
                        
                        // Import mappings
                        for (const [id, data] of Object.entries(config.mappings)) {
                            await db.collection('mappings').doc(id).set(data);
                        }

                        alert('นำเข้าข้อมูลสำเร็จ');
                        loadShifts();
                        loadCompanies();
                        loadMappings();
                    } catch (error) {
                        alert('เกิดข้อผิดพลาดในการนำเข้าข้อมูล: ' + error.message);
                    }
                };
                reader.readAsText(file);
            } catch (error) {
                alert('เกิดข้อผิดพลาดในการอ่านไฟล์: ' + error.message);
            }
        }

        // Add Export/Import buttons to the UI
        const exportImportButtons = `
            <div style="margin-top: 1rem;">
                <button onclick="exportConfiguration()" class="btn btn-primary">Export การตั้งค่า</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" 
                       onchange="importConfiguration(this.files[0])">
                <button onclick="document.getElementById('importFile').click()" class="btn btn-secondary">
                    Import การตั้งค่า
                </button>
            </div>
        `;
        document.querySelector('.card').insertAdjacentHTML('beforeend', exportImportButtons);
    </script>
</body>
</html>