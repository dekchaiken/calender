<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyfence - Following Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FDB813;
            --primary-dark: #e5a700;
            --secondary: #404040;
            --accent: #2D2D2D;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            box-sizing: border-box;
            font-family: 'Noto Sans Thai', sans-serif;
            margin: 0;
            padding: 0;
        }

        #loadingScreen {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        body {
            min-height: 100vh;
            background: linear-gradient(145deg, #f5f5f5 0%, #e8e8e8 100%);
        }

        .user-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: auto;
            padding: 0.5rem 1rem;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: #ddd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
        }

        .user-name {
            font-weight: 500;
            color: #333;
        }

        .logout-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn {
            padding: 0.5rem 1rem;
            background: #f0f0f0;
            color: var(--secondary);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #cc0000;
            transform: translateY(-2px);
        }

        .logout-container {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 1rem 2rem;
            background: white;
            box-shadow: var(--shadow);
        }

        .logo {
            height: 40px;
            margin-right: 2rem;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .header h1 {
            font-size: 1.5rem;
            color: var(--secondary);
            margin: 0;
            flex-grow: 1;
        }

        .container {
            max-width: 1500px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.12);
        }

        .card h2 {
            color: var(--secondary);
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--accent);
            box-shadow: 0 2px 4px rgba(253, 184, 19, 0.2);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .company-filters {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .company-checkbox {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: #f8f8f8;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .company-checkbox:hover {
            background: #f0f0f0;
            transform: translateY(-1px);
        }

        .company-checkbox input {
            margin-right: 0.75rem;
            width: 16px;
            height: 16px;
        }

        .search-box {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary);
        }

        .preview-area {
            background: #f8f8f8;
            padding: 1.5rem;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
            min-height: 200px;
            border: 2px solid #eee;
            margin-bottom: 1rem;
        }

        #dropZone {
            border: 2px dashed #ddd;
            padding: 3rem;
            text-align: center;
            margin: 1rem 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        #dropZone:hover {
            border-color: var(--primary);
            background: #fafafa;
        }

        .nav-btn:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }

            .card {
                padding: 1.5rem;
            }

            .company-filters {
                grid-template-columns: 1fr;
            }
        }
         .loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

          .alert-message {
            margin: 1rem 0;
            line-height: 1.5;
            color: var(--secondary);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
         .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 100%;
            max-width: 500px;
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--secondary);
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .save-btn {
            background: var(--primary);
            color: var(--accent);
        }

        .cancel-btn {
            background: #f0f0f0;
            color: var(--secondary);
        }

        .save-btn,
        .cancel-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div id="loadingScreen">
        <div class="spinner"></div>
        <div id="loadingMessage">กำลังตรวจสอบการเข้าสู่ระบบ...</div>
    </div>
        <!-- Alert Modal -->
        <div id="alertModal" class="modal">
            <div class="modal-content">
                <h3 id="alertTitle">แจ้งเตือน</h3>
                <p id="alertMessage" class="alert-message"></p>
                <div class="modal-buttons">
                    <button type="button" class="save-btn" onclick="closeAlertModal()">ตกลง</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p id="loadingMessage">กำลังดำเนินการ...</p>
            </div>
        </div>

    <div id="mainContent" style="display: none">
         <div class="header">
            <img src="https://www.cyfence.com/wp-content/uploads/2021/09/%E0%B8%A5%E0%B8%87%E0%B9%80%E0%B8%A7%E0%B9%87%E0%B8%9A%E0%B9%83%E0%B8%AB%E0%B8%A1%E0%B9%88.jpg"
                alt="Cyfence Logo" class="logo">
            <h1>Following Report</h1>
            <div class="user-container">
                <span class="user-name" id="userDisplayName">Loading...</span>
                <button onclick="window.location.href='dashboard.html'" class="nav-btn">กลับหน้าหลัก</button>
                <button id="customerManagementBtn" onclick="window.location.href='customer-management.html'" class="nav-btn" style="display: none;">จัดการลูกค้า</button>
                <button onclick="logout()" class="logout-btn">ออกจากระบบ</button>
           </div>
        </div>

        <div class="container">
            <div class="card">
                <h2>เลือกวันที่ติดตาม</h2>
                <div class="form-group">
                    <label for="followDate">วันที่ติดตาม:</label>
                    <input type="date" id="followDate" class="form-control">
                </div>
            </div>

            <div class="card">
                <h2>อัพโหลดไฟล์ Excel</h2>
                <div id="dropZone">
                    ลากไฟล์มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                </div>
                <div id="debug" class="debug-info" style="display: none;"></div>
            </div>

            <div class="card">
                <h2>เลือกบริษัทที่ต้องการกรอง</h2>
                <div class="filter-controls">
                    <input type="text" id="searchCompany" class="search-box" placeholder="ค้นหาชื่อบริษัท...">
                    <button onclick="selectAllCompanies()" class="nav-btn">เลือกทั้งหมด</button>
                    <button onclick="deselectAllCompanies()" class="logout-btn">ยกเลิกทั้งหมด</button>
                    <button onclick="exportExcelByCompany()" class="btn btn-primary">Export Excel แยกตามบริษัท</button>
                </div>
                <div id="companyFilters" class="company-filters">
                    <!-- Company checkboxes will be dynamically added here -->
                </div>
            </div>

            <div class="card">
                <h2>Template สำหรับบริษัทที่เลือก</h2>
                <div id="allTemplates" class="preview-area">
                    โปรดเลือกวันที่และอัพโหลดไฟล์ Excel...
                </div>
                <button onclick="copyAllTemplates()" class="btn btn-primary" style="margin-top: 1rem;">คัดลอก Template
                    ทั้งหมด</button>
            </div>
            <div class="card">
                <h2>หมายเหตุและวิธีการใช้งาน</h2>
                <div class="info-content" style="background: #f8f8f8; padding: 1rem; border-radius: 8px;">
                    <h3 style="color: #2D2D2D; margin-bottom: 0.5rem;">การ Export Excel:</h3>
                    <ul style="list-style-type: disc; margin-left: 1.5rem;">
                        <li>ระบบจะ Export เฉพาะบริษัทที่คุณเลือกในส่วน "เลือกบริษัทที่ต้องการกรอง"</li>
                        <li>ไฟล์ Excel จะถูกแยกตามบริษัท โดยชื่อไฟล์จะเป็น: [ชื่อบริษัท]_Incidents_[วันที่].xlsx</li>
                        <li>ข้อมูลจะถูกจัดเรียงตามลำดับ: Incident ID, Summary, Customer และข้อมูลอื่นๆ</li>
                    </ul>

                    <h3 style="color: #2D2D2D; margin: 1rem 0 0.5rem;">วิธีการใช้งาน:</h3>
                    <ol style="list-style-type: decimal; margin-left: 1.5rem;">
                        <li>เลือกวันที่ติดตาม</li>
                        <li>อัพโหลดไฟล์ Excel ที่ต้องการ</li>
                        <li>เลือกบริษัทที่ต้องการจากรายการ</li>
                        <li>กดปุ่ม "Export Excel แยกตามบริษัท" เพื่อดาวน์โหลดไฟล์</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const newStyles = `
.company-group {
    margin-bottom: 1rem;
    padding: 1rem;
    background-color: #fff;
    border-radius: 8px;
    border: 1px solid #e5e5e5;
}

.company-group-content {
    max-height: 200px;
    overflow-y: auto;
    padding-right: 10px;
    border: 1px solid #eee;
    border-radius: 4px;
}

.company-group-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    background-color: #FDB813;
    border-radius: 4px;
    color: #2D2D2D;
}

.company-group-title {
    margin: 0;
    font-size: 14px;
    font-weight: 500;
}

.select-group-btn {
    background-color: #2D2D2D;
    color: white;
    border: none;
    padding: 4px 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 12px;
}

.select-group-btn:hover {
    background-color: #404040;
    transform: translateY(-1px);
}

.company-checkbox {
    display: block;
    padding: 8px;
    margin: 2px 0;
    background: #f8f8f8;
    border-radius: 4px;
    transition: background-color 0.2s;
    font-size: 13px;
}
    
.company-checkbox input[type="checkbox"] {
    margin-right: 8px;
    width: 14px;
    height: 14px;
}

.company-checkbox:hover {
    background: #f0f0f0;
}

.company-group-content::-webkit-scrollbar {
    width: 8px;
}

.company-group-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.company-group-content::-webkit-scrollbar-thumb {
    background: #FDB813;
    border-radius: 4px;
}

.company-group-content::-webkit-scrollbar-thumb:hover {
    background: #e5a700;
}
`;

        const styleSheet = document.createElement("style");
        styleSheet.textContent = newStyles;
        document.head.appendChild(styleSheet);

    
        const months = [
            'January', 'February', 'March', 'April',
            'May', 'June', 'July', 'August',
            'September', 'October', 'November', 'December'
        ];

        let excelData = null;
        let companies = new Set();
        let selectedCompanies = new Set();

         // เพิ่มฟังก์ชันสำหรับแสดงข้อความแจ้งเตือน
        function showAlertModal(message) {
        document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').style.display = 'flex';
        }

        function closeAlertModal() {
        document.getElementById('alertModal').style.display = 'none';
        }

        function showLoadingOverlay(message) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingMessage').textContent = message;
        }

        function closeLoadingOverlay() {
        document.getElementById('loadingOverlay').style.display = 'none';
        }

         function isDataReady() {
            return (
                companyGroups &&
                Object.keys(companyGroups).length > 0 &&
                companyTypes &&
                companyMappings &&
                companyFullNames
            );
        }

        function handleFile(file) {
               if (!isDataReady()) {
                showAlertModal('กรุณารอข้อมูลโหลดให้เสร็จก่อนอัพโหลดไฟล์');
                return;
            }
        }

        function formatDateToEng(date) {
            const d = new Date(date);
            return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
        }

        // ฟังก์ชันสำหรับจัดการการค้นหาบริษัท
        document.getElementById('searchCompany').addEventListener('input', function (e) {
             showLoadingOverlay('กำลังค้นหา...');
            const searchTerm = e.target.value.toLowerCase();
            const checkboxes = document.querySelectorAll('.company-checkbox');

            checkboxes.forEach(checkbox => {
                const companyName = checkbox.textContent.toLowerCase();
                checkbox.style.display = companyName.includes(searchTerm) ? '' : 'none';
            });
                closeLoadingOverlay();
        });

          function selectAllCompanies() {
              showLoadingOverlay('กำลังเลือกบริษัททั้งหมด...');
            const checkboxes = document.querySelectorAll('.company-checkbox input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                selectedCompanies.add(checkbox.value);
            });
              updateAllTemplates();
             closeLoadingOverlay();
        }
        

        function deselectAllCompanies() {
              showLoadingOverlay('กำลังยกเลิกการเลือกบริษัททั้งหมด...');
            const checkboxes = document.querySelectorAll('.company-checkbox input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                selectedCompanies.delete(checkbox.value);
            });
              updateAllTemplates();
             closeLoadingOverlay();
        }

        function generateTemplate(companyCode, formattedDate, incidents) {
            const isHospital = companyTypes[companyCode] === 'hospital';
            let template = '';

            if (isHospital) {
                // Template for hospitals
                template += `เรียนทีม ${companyFullNames[companyCode]}\n`;
                template += `${companyCode} Follow Incident ${formattedDate} (ติดตาม Incident ที่สถานะยังคง Pending)\n\n`;
            } else {
                // Template for regular companies
                template += `เรียนทีม ${companyCode}\n`;
                template += `${companyCode} Follow Incident ${formattedDate}\n\n`;
            }

            if (incidents.length > 0) {
                template += `ขอแจ้ง Incident ที่มีสถานะยังคง Pending ครับ\n`;
                incidents.forEach((incident, idx) => {
                    template += `${idx + 1}. ${incident['Incident ID']} ${incident.Summary}\n`;
                });
                template += `\nรายละเอียดเพิ่มเติม ส่งให้ทาง E-mail ครับ\n`;
                template += `หากดำเนินการแก้ไขแล้ว รบกวนแจ้งปิดเคสด้วยครับ`;
            } else {
                template += `- ไม่พบ Incident ที่มีสถานะ pending ครับ`;
            }

            return template;
        }

        function updateCompanyFilters() {
            const filtersContainer = document.getElementById('companyFilters');
            filtersContainer.innerHTML = '';

             // แปลง companyGroups เป็น Array เพื่อให้สามารถเรียงลำดับได้
            const sortedGroups = Object.entries(companyGroups)
                .sort((a, b) => {
                    const numA = parseInt(a[0].replace('Shift ', '')) || Infinity;
                    const numB = parseInt(b[0].replace('Shift ', '')) || Infinity;
                    return numA - numB;
                });

            sortedGroups.forEach(([groupId, group]) => {
                console.log(`Processing group ${groupId}:`, group); // Log ข้อมูลแต่ละกลุ่ม

                // ถ้า group เป็น array โดยตรง (กรณีที่ไม่มี name)
                const companies = Array.isArray(group) ? group : group.companies;
                const groupName = Array.isArray(group) ? groupId : (group.name || groupId);

                if (!companies || !Array.isArray(companies)) {
                    console.warn(`Invalid companies data for ${groupId}:`, companies);
                    return;
                }

                const groupDiv = document.createElement('div');
                groupDiv.className = 'company-group';

                const header = document.createElement('div');
                header.className = 'company-group-header';

                const groupTitle = document.createElement('h3');
                groupTitle.className = 'company-group-title';
                groupTitle.textContent = groupName;
                header.appendChild(groupTitle);

                const buttonContainer = document.createElement('div');
                buttonContainer.style.display = 'flex';
                buttonContainer.style.gap = '8px';

                const selectGroupBtn = document.createElement('button');
                selectGroupBtn.textContent = 'Select All';
                selectGroupBtn.className = 'select-group-btn';
                selectGroupBtn.onclick = () => selectGroupCompanies(companies);

                const unselectGroupBtn = document.createElement('button');
                unselectGroupBtn.textContent = 'Unselect All';
                unselectGroupBtn.className = 'select-group-btn';
                unselectGroupBtn.style.backgroundColor = '#404040';
                unselectGroupBtn.onclick = () => unselectGroupCompanies(companies);

                buttonContainer.appendChild(selectGroupBtn);
                buttonContainer.appendChild(unselectGroupBtn);
                header.appendChild(buttonContainer);

                groupDiv.appendChild(header);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'company-group-content';

                companies.forEach(company => {
                    const label = document.createElement('label');
                    label.className = 'company-checkbox';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = company;
                    checkbox.checked = selectedCompanies.has(company);
                    checkbox.addEventListener('change', function () {
                       showLoadingOverlay('กำลังอัพเดต Template...');
                        if (this.checked) {
                            selectedCompanies.add(this.value);
                        } else {
                            selectedCompanies.delete(this.value);
                        }
                        updateAllTemplates();
                        closeLoadingOverlay();
                    });

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(company));
                    contentDiv.appendChild(label);
                });

                groupDiv.appendChild(contentDiv);
                filtersContainer.appendChild(groupDiv);
            });
        }

        function unselectGroupCompanies(groupCompanies) {
               showLoadingOverlay('กำลังยกเลิกการเลือกบริษัท...');
            groupCompanies.forEach(company => {
                if (companies.has(company)) {
                    selectedCompanies.delete(company);
                    const checkbox = document.querySelector(`input[type="checkbox"][value="${company}"]`);
                    if (checkbox) checkbox.checked = false;
                }
            });
              updateAllTemplates();
             closeLoadingOverlay();
        }
        
        function selectGroupCompanies(groupCompanies) {
            showLoadingOverlay('กำลังเลือกบริษัท...');
            groupCompanies.forEach(company => {
                if (companies.has(company)) {
                    selectedCompanies.add(company);
                    const checkbox = document.querySelector(`input[type="checkbox"][value="${company}"]`);
                    if (checkbox) checkbox.checked = true;
                }
            });
            updateAllTemplates();
             closeLoadingOverlay();
        }

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const debugDiv = document.getElementById('debug');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
         dropZone.addEventListener('drop', (e) => {
             e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            handleFileAndLoad(file); // Call the new function
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
             handleFileAndLoad(file); // Call the new function
        });
           async function handleFileAndLoad(file) {
            showLoadingOverlay('กำลังอ่านไฟล์ Excel...');
                try {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                         try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        excelData = XLSX.utils.sheet_to_json(firstSheet);
                        
                          // เพิ่มบริษัททั้งหมดจาก companyMappings
                             companies = new Set([
                             ...new Set(excelData.map(incident => getCompanyCode(incident.Customer))),
                                ...new Set(Object.values(companyMappings))
                            ]);
                        selectedCompanies = new Set(companies); // เลือกทุกบริษัทเริ่มต้น
                        
                           updateCompanyFilters();
                           updateAllTemplates();

                        debugDiv.style.display = 'block';
                        debugDiv.innerHTML = `อ่านข้อมูลสำเร็จ: ${excelData.length} รายการ`;
                        
                        } catch (error) {
                         debugDiv.style.display = 'block';
                          debugDiv.innerHTML = `เกิดข้อผิดพลาด: ${error.message}`;
                        }
                        closeLoadingOverlay();
                        };
                        reader.readAsArrayBuffer(file);
                        }catch(error){
                    closeLoadingOverlay();
                    debugDiv.style.display = 'block';
                          debugDiv.innerHTML = `เกิดข้อผิดพลาด: ${error.message}`;
                }
        }

        function getCompanyCode(customerName) {
            return companyMappings[customerName] || customerName;
        }

        document.getElementById('followDate').addEventListener('change', () => {
            showLoadingOverlay('กำลังอัพเดต Template...');
              updateAllTemplates();
              closeLoadingOverlay();
        });
           

        function updateAllTemplates() {
            const date = document.getElementById('followDate').value;
            if (!date || !excelData) {
                 document.getElementById('allTemplates').textContent = 'โปรดเลือกวันที่และอัพโหลดไฟล์ Excel...';
                return;
            }

            const formattedDate = formatDateToEng(date);
            let allTemplates = '';

            // กรองเฉพาะบริษัทที่ถูกเลือกจาก checkbox
            const selectedCompaniesArray = Array.from(selectedCompanies).sort();

            selectedCompaniesArray.forEach((companyCode, index) => {
                const checkbox = document.querySelector(`input[type="checkbox"][value="${companyCode}"]`);

                // สร้าง template เฉพาะบริษัทที่ถูกเลือกใน checkbox
                if (checkbox && checkbox.checked) {
                    if (index > 0) {
                        allTemplates += '\n\n' + '='.repeat(50) + '\n\n';
                    }

                    const incidents = excelData.filter(incident =>
                        getCompanyCode(incident.Customer) === companyCode
                    );

                    allTemplates += generateTemplate(companyCode, formattedDate, incidents);
                }
            });

            document.getElementById('allTemplates').textContent = allTemplates || 'กรุณาเลือกบริษัทที่ต้องการดู Template';
        }

         function copyAllTemplates() {
             showLoadingOverlay('กำลังคัดลอก Template...');
             const templates = document.getElementById('allTemplates').textContent;
            navigator.clipboard.writeText(templates)
                 .then(() =>{
                      closeLoadingOverlay();
                     showAlertModal('คัดลอก Template ทั้งหมดสำเร็จ')
                  })
                .catch(err => {
                    closeLoadingOverlay();
                     showAlertModal('เกิดข้อผิดพลาดในการคัดลอก: ' + err);
                });
        }

         function exportExcelByCompany() {
             showLoadingOverlay('กำลัง Export Excel...');
            if (!excelData || selectedCompanies.size === 0) {
               closeLoadingOverlay();
               showAlertModal('กรุณาอัพโหลดไฟล์ Excel และเลือกบริษัทก่อน');
                return;
            }

            const date = document.getElementById('followDate').value;
            if (!date) {
                closeLoadingOverlay();
               showAlertModal('กรุณาเลือกวันที่ก่อน Export');
                return;
            }

            const formattedDate = formatDateToEng(date);
            const checkboxes = document.querySelectorAll('.company-checkbox input[type="checkbox"]:checked');

            if (checkboxes.length === 0) {
                 closeLoadingOverlay();
                 showAlertModal('กรุณาเลือกอย่างน้อย 1 บริษัท');
                return;
            }

            checkboxes.forEach(checkbox => {
                const companyCode = checkbox.value;
                const companyData = excelData.filter(incident =>
                    getCompanyCode(incident.Customer) === companyCode
                );

                if (companyData.length === 0) return;

                const formattedData = companyData.map(incident => ({
                    'Incident ID': incident['Incident ID'],
                    'Summary': incident['Summary'],
                    'Customer': incident['Customer'],
                    ...Object.keys(incident)
                        .filter(key => !['Incident ID', 'Customer', 'Summary'].includes(key))
                        .reduce((obj, key) => ({
                            ...obj,
                            [key]: incident[key]
                        }), {})
                }));

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(formattedData);
                XLSX.utils.book_append_sheet(wb, ws, companyCode);

                // Generate filename based on company type
                const fileName = `${companyCode} Follow Incident ${formattedDate}.xlsx`;

                XLSX.writeFile(wb, fileName);
            });
                closeLoadingOverlay();
                 showAlertModal('Export Excel สำเร็จ');
        }

        // ฟังก์ชันช่วยจัดรูปแบบวันที่สำหรับชื่อไฟล์
        function formatDateForFileName(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }
    </script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script>
        // Firebase initialization
        firebase.initializeApp({
            apiKey: "AIzaSyAcb9q1eX1QM9Gl_W6U9WZNbeg6M-uyhpk",
            authDomain: "cyfencedevbyken.firebaseapp.com",
            projectId: "cyfencedevbyken",
            storageBucket: "cyfencedevbyken.appspot.com",
            messagingSenderId: "632813871756",
            appId: "1:632813871756:web:57d674643f258ddd2e11a9",
        });

        let companyGroups = {};
        let companyTypes = {};
        let companyMappings = {};
        let companyFullNames = {};

        async function loadCustomerData() {
            showLoadingOverlay('กำลังโหลดข้อมูลลูกค้า...');
    try {
        const db = firebase.firestore();
        
        // โหลด companyGroups และ log ข้อมูลที่ได้
        const groupsDoc = await db.collection('customerManagement')
            .doc('companyGroups').get();
        
        if (groupsDoc.exists) {
            const data = groupsDoc.data();
            console.log('Raw data from Firestore:', data); // ดูข้อมูลดิบที่ได้จาก Firestore

            // ถ้าข้อมูลมี shifts อยู่แล้ว
            if (data && data.shifts) {
                companyGroups = data.shifts;
            } 
            // ถ้าข้อมูลเป็น object ที่มี key เป็น Shift 1, Shift 2, etc. โดยตรง
            else if (data && Object.keys(data).some(key => key.startsWith('Shift'))) {
                 // แปลง Object เป็น Array ของ [key, value] เพื่อให้สามารถ Sort ได้
                const sortedEntries = Object.entries(data).sort((a, b) => {
                  const numA = parseInt(a[0].replace('Shift ', '')) || Infinity;
                  const numB = parseInt(b[0].replace('Shift ', '')) || Infinity;
                    return numA - numB;
                });

                // แปลงกลับเป็น Object หลังจาก Sort แล้ว
                companyGroups = Object.fromEntries(sortedEntries);
            }
            else {
                console.warn('No valid shifts data found');
                companyGroups = {};
            }

            console.log('Processed companyGroups:', companyGroups); // ดูข้อมูลหลังจัดรูปแบบ
        }

        // โหลดข้อมูลอื่นๆ เหมือนเดิม
        const [typesDoc, mappingsDoc, fullNamesDoc] = await Promise.all([
            db.collection('customerManagement').doc('companyTypes').get(),
            db.collection('customerManagement').doc('companyMappings').get(),
            db.collection('customerManagement').doc('companyFullNames').get()
        ]);

        companyTypes = typesDoc.exists ? typesDoc.data() : {};
        companyMappings = mappingsDoc.exists ? mappingsDoc.data() : {};
        companyFullNames = fullNamesDoc.exists ? fullNamesDoc.data() : {};

        console.log('Loaded companyTypes:', companyTypes);
        console.log('Loaded companyMappings:', companyMappings);
        console.log('Loaded companyFullNames:', companyFullNames);

        if (Object.keys(companyGroups).length > 0) {
            updateCompanyFilters();
        } else {
            document.getElementById('companyFilters').innerHTML = 
                '<p>ไม่พบข้อมูลบริษัท กรุณาตรวจสอบการตั้งค่าข้อมูลในระบบ</p>';
        }
         closeLoadingOverlay();
        
    } catch (error) {
        console.error('Error loading customer data:', error);
        document.getElementById('companyFilters').innerHTML = 
            '<p>เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณารีเฟรชหน้าเว็บ</p>';
          closeLoadingOverlay();
    }
}


    </script>
    <script>
        // อัปเดตข้อมูลผู้ใช้เมื่อโหลดหน้า
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                await loadCustomerData();
                try {
                    const userDoc = await firebase.firestore()
                        .collection('users')
                        .doc(user.uid)
                        .get();

                    const userData = userDoc.data();
                    const displayElement = document.getElementById('userDisplayName');

                    if (userData?.displayName) {
                        displayElement.textContent = userData.displayName;
                    } else {
                        displayElement.textContent = user.email;
                    }

                    if (userData?.role === 'supervisor' || userData?.role === 'admin') {
                   document.getElementById('customerManagementBtn').style.display = 'inline-block';
                 }
                    // Add admin button if user has admin role
                } catch (error) {
                    console.error('Error fetching user data:', error);
                }
            }
        });

        function logout() {
            firebase.auth().signOut()
                .then(() => window.location.href = 'login.html')
                .catch(error => console.error('Logout error:', error));
        }
    </script>
    <script src="auth.js"></script>
</body>

</html>
