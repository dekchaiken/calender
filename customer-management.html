<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyfence - ระบบจัดการข้อมูลลูกค้า</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FDB813;
            --primary-dark: #e5a700;
            --secondary: #404040;
            --accent: #2D2D2D;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            box-sizing: border-box;
            font-family: 'Noto Sans Thai', sans-serif;
            margin: 0;
            padding: 0;
        }

        #loadingScreen {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        body {
            min-height: 100vh;
            background: linear-gradient(145deg, #f5f5f5 0%, #e8e8e8 100%);
        }

        .header {
            display: flex;
            align-items: center;
            padding: 1rem 2rem;
            background: white;
            box-shadow: var(--shadow);
        }

        .logo {
            height: 40px;
            margin-right: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--primary);
            color: var(--accent);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--secondary);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 1rem;
        }

        .customer-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .customer-item {
            background: #f8f8f8;
            padding: 1rem;
            border-radius: 8px;
            position: relative;
        }

        .customer-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--accent);
        }

        .btn-danger {
            background: #ff4444;
            color: white;
        }

        .shift-group {
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8f8f8;
            border-radius: 8px;
        }

        .shift-title {
            font-size: 1.2rem;
            color: var(--secondary);
            margin-bottom: 1rem;
        }

        .search-box {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #eee;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .user-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: auto;
            padding: 0.5rem 1rem;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: auto;
        }

        .nav-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .logout-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .alert-message {
            margin: 1rem 0;
            line-height: 1.5;
            color: var(--secondary);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 100%;
            max-width: 500px;
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--secondary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--secondary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .save-btn {
            background: var(--primary);
            color: var(--accent);
        }

        .cancel-btn {
            background: #f0f0f0;
            color: var(--secondary);
        }

        .save-btn,
        .cancel-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div id="loadingScreen">
        <div class="spinner"></div>
        <div id="loadingMessage">กำลังตรวจสอบการเข้าสู่ระบบ...</div>
    </div>
    
        <!-- Alert Modal -->
        <div id="alertModal" class="modal">
            <div class="modal-content">
                <h3 id="alertTitle">แจ้งเตือน</h3>
                <p id="alertMessage" class="alert-message"></p>
                <div class="modal-buttons">
                    <button type="button" class="save-btn" onclick="closeAlertModal()">ตกลง</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p id="loadingMessage">กำลังดำเนินการ...</p>
            </div>
        </div>

    <div id="mainContent" style="display: none">
        <div class="header">
            <img src="https://www.cyfence.com/wp-content/uploads/2021/09/%E0%B8%A5%E0%B8%87%E0%B9%80%E0%B8%A7%E0%B9%87%E0%B8%9A%E0%B9%83%E0%B8%AB%E0%B8%A1%E0%B9%88.jpg"
                alt="Cyfence Logo" class="logo">
            <h1>Customer Management</h1>
            <div class="user-container">
                <span class="user-info" id="userDisplayName">Loading...</span>
                <button onclick="window.location.href='admin.html'" class="nav-btn">กลับหน้าแอดมิน</button>
                <button onclick="logout()" class="logout-btn">ออกจากระบบ</button>
            </div>
        </div>

        <div class="container">
            <div class="tabs">
                <button class="tab active" onclick="showTab('allInfo')"
                    style="margin-top: 1rem; padding: 0.75rem 2rem; font-weight: 600;">ข้อมูลทั้งหมดของลูกค้า</button>
                <button class="tab" onclick="showTab('customers')"
                    style="margin-top: 1rem; padding: 0.75rem 2rem; font-weight: 600;">จัดการลูกค้า</button>
                <button class="tab" onclick="showTab('mappings')"
                    style="margin-top: 1rem; padding: 0.75rem 2rem; font-weight: 600;">จัดการ Mappings</button>
                <button class="tab" onclick="showTab('callings')"
                    style="margin-top: 1rem; padding: 0.75rem 2rem; font-weight: 600;">จัดการการเรียกชื่อ</button>
            </div>

            <div id="allInfo" class="tab-content">
                <div class="card">
                    <h2>ข้อมูลทั้งหมดของลูกค้า</h2>
                    <input type="text" class="search-box" placeholder="ค้นหาข้อมูลลูกค้า..."
                        oninput="searchAllCustomerInfo(this.value)">
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th
                                        style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">
                                        ชื่อย่อ</th>
                                    <th
                                        style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">
                                        ชื่อเต็ม</th>
                                    <th
                                        style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">
                                        ประเภท</th>
                                    <th
                                        style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">
                                        Shift</th>
                                    <th
                                        style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">
                                        รูปแบบการเรียก</th>
                                    <th
                                        style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">
                                        เมนูจัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="allCustomerInfo">
                                <!-- ข้อมูลจะถูกเพิ่มด้วย JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="customers" class="tab-content" style="display: none;">
                <div class="card">
                    <h2 style="margin-bottom: 1.5rem; color: #2D2D2D;">เพิ่มลูกค้าใหม่</h2>
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 0.5rem;">ชื่อลูกค้า (ชื่อย่อ)</label>
                        <input type="text" class="form-control" id="customerName" placeholder="เช่น BLA"
                            style="padding: 0.75rem; border: 2px solid #eee; transition: border-color 0.3s ease;">
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 0.5rem;">ชื่อสำหรับ Mapping (ชื่อเต็ม)</label>
                        <input type="text" class="form-control" id="customerMapping"
                            placeholder="เช่น บริษัท กรุงเทพประกันชีวิต จำกัด (มหาชน)"
                            style="padding: 0.75rem; border: 2px solid #eee; transition: border-color 0.3s ease;">
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 0.5rem;">ประเภท</label>
                        <select class="form-control" id="customerType"
                            style="padding: 0.75rem; border: 2px solid #eee; transition: border-color 0.3s ease;">
                            <option value="company">บริษัท</option>
                            <option value="hospital">โรงพยาบาล</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 0.5rem;">Shift</label>
                        <select class="form-control" id="customerShift"
                            style="padding: 0.75rem; border: 2px solid #eee; transition: border-color 0.3s ease;">
                            <option value="Shift 1">Shift 1</option>
                            <option value="Shift 2">Shift 2</option>
                            <option value="Shift 3">Shift 3</option>
                            <option value="Shift 4">Shift 4</option>
                            <option value="Shift 5">Shift 5</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="addCustomer()"
                        style="margin-top: 1rem; padding: 0.75rem 2rem; font-weight: 600;">เพิ่มลูกค้า</button>
            
                </div>
            </div>

            <div id="shifts" class="tab-content" style="display: none;">
                <div class="card">
                    <h2>จัดการ Shifts</h2>
                    <div class="shift-group" id="shiftsList">
                        <!-- รายการ Shifts จะถูกเพิ่มที่นี่ด้วย JavaScript -->
                    </div>
                </div>
            </div>

            <div id="mappings" class="tab-content" style="display: none;">
                <div class="card">
                    <h2>จัดการ Mappings</h2>
                     <div class="form-group">
                        <label>ชื่อที่แสดงในระบบ</label>
                        <input type="text" class="form-control" id="mappingDisplay">
                    </div>
                    <div class="form-group">
                        <label>ชื่อที่ใช้แทน</label>
                        <input type="text" class="form-control" id="mappingReplace">
                    </div>
                    <button class="btn btn-primary" onclick="addMapping()">เพิ่ม Mapping</button>
                </div>
                <div class="card">
                    <h2>รายชื่อ Mappings ทั้งหมด</h2>
                    <div id="mappingList">
                        <!-- ข้อมูล Mapping จะถูกเพิ่มที่นี่ด้วย JavaScript -->
                    </div>
                </div>
            </div>
    
            <div id="callings" class="tab-content" style="display: none;">
                 <div class="card">
                    <h2>จัดการการเรียกชื่อลูกค้า</h2>
                    <div class="form-group">
                        <label>เลือกลูกค้า</label>
                        <select class="form-control" id="customerSelect">
                            <option value="">-- เลือกลูกค้า --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>รูปแบบการเรียก</label>
                        <input type="text" class="form-control" id="callingPattern"
                            placeholder="เช่น เจ้าหน้าที่โรงพยาบาลบ้านด่าน">
                    </div>
                    <button class="btn btn-primary" onclick="saveCustomerCalling()">บันทึก</button>
                </div>
    
                <div class="card">
                    <h2>รายการการเรียกชื่อทั้งหมด</h2>
                    <div id="callingList"></div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script>
        // Firebase initialization (ใช้ config เดิมจากไฟล์ following.html)
        firebase.initializeApp({
            apiKey: "AIzaSyAcb9q1eX1QM9Gl_W6U9WZNbeg6M-uyhpk",
            authDomain: "cyfencedevbyken.firebaseapp.com",
            projectId: "cyfencedevbyken",
            storageBucket: "cyfencedevbyken.appspot.com",
            messagingSenderId: "632813871756",
            appId: "1:632813871756:web:57d674643f258ddd2e11a9",
        });

        let companyTypes = {};
        let companyGroups = {};

         // เพิ่มฟังก์ชันสำหรับแสดงข้อความแจ้งเตือน
        function showAlertModal(message) {
        document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').style.display = 'flex';
        }

        function closeAlertModal() {
        document.getElementById('alertModal').style.display = 'none';
        }

        function showLoadingOverlay(message) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingMessage').textContent = message;
        }

        function closeLoadingOverlay() {
        document.getElementById('loadingOverlay').style.display = 'none';
        }

        async function loadCustomerData() {
            try {
                const db = firebase.firestore();

                // โหลดข้อมูลเดิม
                const typesDoc = await db.collection('customerManagement').doc('companyTypes').get();
                const groupsDoc = await db.collection('customerManagement').doc('companyGroups').get();
                const mappingsDoc = await db.collection('customerManagement').doc('companyMappings').get();

                if (typesDoc.exists) {
                    companyTypes = typesDoc.data();
                }
                if (groupsDoc.exists && groupsDoc.data().shifts) {
                    companyGroups = groupsDoc.data().shifts;
                }

                // สร้าง mapping สำหรับชื่อเรียกโรงพยาบาล
                const hospitalCallings = {};
                if (mappingsDoc.exists) {
                    const mappings = mappingsDoc.data();
                    Object.entries(mappings).forEach(([fullName, shortName]) => {
                        // ตรวจสอบว่าเป็นโรงพยาบาลหรือไม่
                        if (companyTypes[shortName] === 'hospital') {
                            // ดึงชื่อโรงพยาบาลจากชื่อเต็ม
                            const hospitalName = fullName.replace('โรงพยาบาล', '').trim();
                            hospitalCallings[shortName] = `เจ้าหน้าที่โรงพยาบาล${hospitalName}`;
                        }
                    });
                }

                // บันทึก mapping ใหม่ลง Firestore
                await db.collection('customerManagement').doc('hospitalCallings').set(hospitalCallings);
                // ไม่ต้อง refresh list แล้ว
                // refreshCustomerList();
            } catch (error) {
                console.error('Error loading customer data:', error);
                showAlertModal('เกิดข้อผิดพลาดในการโหลดข้อมูล');
            }
        }

        async function getHospitalCallings() {
            try {
                const db = firebase.firestore();
                const doc = await db.collection('customerManagement').doc('hospitalCallings').get();
                if (doc.exists) {
                    return doc.data();
                }
                return {};
            } catch (error) {
                console.error('Error getting hospital callings:', error);
                return {};
            }
        }

        async function saveCustomerData(type, data) {
            try {
                const db = firebase.firestore();
                await db.collection('customerManagement')
                    .doc(type)
                    .set(data);
                showAlertModal('บันทึกข้อมูลสำเร็จ');
            } catch (error) {
                console.error('Error saving data:', error);
                showAlertModal('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
            }
        }

        async function loadShiftData() {
            const shiftsList = document.getElementById('shiftsList');
            shiftsList.innerHTML = '';

            try {
                const db = firebase.firestore();
                const groupsDoc = await db.collection('customerManagement').doc('companyGroups').get();
                const shifts = groupsDoc.exists ? groupsDoc.data().shifts : {};

                // สร้าง UI สำหรับแต่ละ Shift
                Object.entries(shifts).forEach(([shiftName, companies]) => {
                    const shiftDiv = document.createElement('div');
                    shiftDiv.className = 'shift-group';
                    shiftDiv.style.marginBottom = '1rem';
                    shiftDiv.style.padding = '1rem';
                    shiftDiv.style.backgroundColor = '#f8f8f8';
                    shiftDiv.style.borderRadius = '8px';

                    const companyCount = companies ? companies.length : 0;

                    shiftDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">${shiftName}</h3>
                    <span class="badge" style="background: #FDB813; padding: 0.25rem 0.5rem; border-radius: 4px;">
                        ${companyCount} บริษัท
                    </span>
                </div>
                <div class="company-list" style="margin-top: 0.5rem;">
                    ${companies ? companies.map(company => `
                        <div style="background: white; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 4px;">
                            ${company}
                        </div>
                    `).join('') : 'ไม่มีบริษัทในกะนี้'}
                </div>
            `;

                    shiftsList.appendChild(shiftDiv);
                });
            } catch (error) {
                console.error('Error loading shift data:', error);
                shiftsList.innerHTML = '<p style="color: red;">เกิดข้อผิดพลาดในการโหลดข้อมูล Shifts</p>';
            }
        }

        async function addShift(name) {
            const db = firebase.firestore();
            const shiftRef = db.collection('customerManagement').doc('shifts');
            const shiftDoc = await shiftRef.get();
            let shifts = shiftDoc.exists ? shiftDoc.data() : {};
            shifts[name] = []; // เพิ่ม shift ใหม่
            await shiftRef.set(shifts);
            showAlertModal('เพิ่ม Shift สำเร็จ');
        }




        // โหลดข้อมูลการเรียกชื่อลูกค้า
        async function loadCallingData() {
            try {
                const db = firebase.firestore();

                // โหลดข้อมูลลูกค้าทั้งหมด
                const mappingsDoc = await db.collection('customerManagement').doc('companyMappings').get();
                const mappings = mappingsDoc.exists ? mappingsDoc.data() : {};

                // โหลดข้อมูลการเรียกชื่อที่มีอยู่
                const callingsDoc = await db.collection('customerManagement').doc('companyFullNames').get();
                const callings = callingsDoc.exists ? callingsDoc.data() : {};

                // อัพเดต dropdown ลูกค้า
                const customerSelect = document.getElementById('customerSelect');
                customerSelect.innerHTML = '<option value="">-- เลือกลูกค้า --</option>';

                Object.entries(mappings).forEach(([fullName, shortName]) => {
                    const option = document.createElement('option');
                    option.value = shortName;
                    option.textContent = `${shortName} (${fullName})`;
                    customerSelect.appendChild(option);
                });

                // แสดงรายการการเรียกชื่อทั้งหมด
                const callingList = document.getElementById('callingList');
                callingList.innerHTML = '';

                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';

                // สร้างส่วนหัวตาราง
                const thead = document.createElement('thead');
                thead.innerHTML = `
            <tr style="background-color: #f8f9fa;">
                <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6;">รหัสลูกค้า</th>
                <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6;"></th>
                <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6;">การเรียกชื่อ</th>
                <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #dee2e6;">จัดการ</th>
            </tr>
        `;
                table.appendChild(thead);

                // สร้างส่วนเนื้อหาตาราง
                const tbody = document.createElement('tbody');
                Object.entries(callings).forEach(([shortName, calling]) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                <td style="padding: 1rem; border-bottom: 1px solid #dee2e6;">${shortName}</td>
                <td style="padding: 1rem; border-bottom: 1px solid #dee2e6;">${mappings[shortName] || ''}</td>
                <td style="padding: 1rem; border-bottom: 1px solid #dee2e6;">${calling}</td>
                <td style="padding: 1rem; border-bottom: 1px solid #dee2e6; text-align: center;">
                    <button onclick="editCalling('${shortName}', '${calling}')" class="btn btn-primary" style="margin-right: 0.5rem;">แก้ไข</button>
                    <button onclick="deleteCalling('${shortName}')" class="btn btn-danger">ลบ</button>
                </td>
            `;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                callingList.appendChild(table);

            } catch (error) {
                console.error('Error loading calling data:', error);
                showAlertModal('เกิดข้อผิดพลาดในการโหลดข้อมูล');
            }
        }

        // บันทึกการเรียกชื่อใหม่
        async function saveCustomerCalling() {
            const customerSelect = document.getElementById('customerSelect');
            const callingPattern = document.getElementById('callingPattern');

            const shortName = customerSelect.value;
            const calling = callingPattern.value.trim();

            if (!shortName || !calling) {
                showAlertModal('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            try {
                const db = firebase.firestore();
                const callingsRef = db.collection('customerManagement').doc('companyFullNames');

                // โหลดข้อมูลเดิม
                const doc = await callingsRef.get();
                const callings = doc.exists ? doc.data() : {};

                // อัพเดทข้อมูล
                callings[shortName] = calling;

                // บันทึกลง Firestore
                await callingsRef.set(callings);

                // รีเซ็ตฟอร์ม
                customerSelect.value = '';
                callingPattern.value = '';

                // โหลดข้อมูลใหม่
                loadCallingData();

                showAlertModal('บันทึกข้อมูลสำเร็จ');
            } catch (error) {
                console.error('Error saving calling:', error);
                showAlertModal('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
            }
        }

        // เพิ่มฟังก์ชันในการโหลดข้อมูลทั้งหมด
        async function loadAllCustomerInfo() {
             showLoadingOverlay('กำลังโหลดข้อมูลลูกค้า...');
            try {
                const db = firebase.firestore();

                // ดึงข้อมูลทั้งหมดที่จำเป็น
                const [typesDoc, groupsDoc, mappingsDoc, callingsDoc] = await Promise.all([
                    db.collection('customerManagement').doc('companyTypes').get(),
                    db.collection('customerManagement').doc('companyGroups').get(),
                    db.collection('customerManagement').doc('companyMappings').get(),
                    db.collection('customerManagement').doc('companyFullNames').get()
                ]);

                const types = typesDoc.exists ? typesDoc.data() : {};
                const groups = groupsDoc.exists ? groupsDoc.data().shifts : {};
                const mappings = mappingsDoc.exists ? mappingsDoc.data() : {};
                const callings = callingsDoc.exists ? callingsDoc.data() : {};

                // สร้างข้อมูลรวม
                const allInfo = [];
                const mappingEntries = Object.entries(mappings);

                mappingEntries.forEach(([fullName, shortName]) => {
                    // หา shift ของลูกค้า
                    let customerShift = '';
                    Object.entries(groups).forEach(([shift, companies]) => {
                        if (companies.includes(shortName)) {
                            customerShift = shift;
                        }
                    });

                    allInfo.push({
                        shortName,
                        fullName,
                        type: types[shortName] || '-',
                        shift: customerShift || '-',
                        calling: callings[shortName] || '-'
                    });
                });

                // เรียงข้อมูลตามชื่อย่อ
                allInfo.sort((a, b) => a.shortName.localeCompare(b.shortName));

                // แสดงข้อมูลในตาราง
                const tbody = document.getElementById('allCustomerInfo');
                tbody.innerHTML = allInfo.map(info => `
            <tr style="border-bottom: 1px solid #dee2e6;">
                <td style="padding: 1rem;">${info.shortName}</td>
                <td style="padding: 1rem;">${info.fullName}</td>
                <td style="padding: 1rem;">${info.type === 'company' ? 'บริษัท' : 'โรงพยาบาล'}</td>
                <td style="padding: 1rem;">${info.shift}</td>
                <td style="padding: 1rem;">${info.calling}</td>
                <td style="padding: 1rem; text-align: center;">
                    <button onclick="editCustomerInfo('${info.shortName}', '${info.fullName}', '${info.type}', '${info.shift}', '${info.calling}')" 
                            class="btn btn-primary" 
                            style="margin-right: 0.5rem; padding: 0.5rem 1rem;">
                        แก้ไข
                    </button>
                </td>
            </tr>
        `).join('');

            } catch (error) {
                console.error('Error loading all customer info:', error);
                showAlertModal('เกิดข้อผิดพลาดในการโหลดข้อมูลลูกค้า');
            }finally {
                closeLoadingOverlay(); // Hide loading
            }
        }

        // เพิ่มฟังก์ชันสำหรับแก้ไขข้อมูลลูกค้า
        async function editCustomerInfo(shortName, fullName, type, shift, calling) {
            // สร้าง modal dialog สำหรับแก้ไขข้อมูล
            const modalHtml = `
        <div id="editModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
            <div style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h2 style="margin-bottom: 1.5rem; color: #2D2D2D;">แก้ไขข้อมูลลูกค้า</h2>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ชื่อย่อ</label>
                    <input type="text" id="editShortName" value="${shortName}" class="form-control" readonly>
                </div>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ชื่อเต็ม</label>
                    <input type="text" id="editFullName" value="${fullName}" class="form-control">
                </div>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ประเภท</label>
                    <select id="editType" class="form-control">
                        <option value="company" ${type === 'company' ? 'selected' : ''}>บริษัท</option>
                        <option value="hospital" ${type === 'hospital' ? 'selected' : ''}>โรงพยาบาล</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Shift</label>
                    <select id="editShift" class="form-control">
                        <option value="Shift 1" ${shift === 'Shift 1' ? 'selected' : ''}>Shift 1</option>
                        <option value="Shift 2" ${shift === 'Shift 2' ? 'selected' : ''}>Shift 2</option>
                        <option value="Shift 3" ${shift === 'Shift 3' ? 'selected' : ''}>Shift 3</option>
                        <option value="Shift 4" ${shift === 'Shift 4' ? 'selected' : ''}>Shift 4</option>
                        <option value="Shift 5" ${shift === 'Shift 5' ? 'selected' : ''}>Shift 5</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">รูปแบบการเรียก</label>
                    <input type="text" id="editCalling" value="${calling}" class="form-control">
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <button onclick="closeEditModal()" class="btn" style="padding: 0.75rem 1.5rem;">ยกเลิก</button>
                    <button onclick="saveEditedCustomer('${shortName}')" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">บันทึก</button>
                </div>
            </div>
        </div>
    `;

            // เพิ่ม modal เข้าไปใน DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // ฟังก์ชันปิด modal
        function closeEditModal() {
            const modal = document.getElementById('editModal');
            if (modal) {
                modal.remove();
            }
        }

        // ฟังก์ชันบันทึกข้อมูลที่แก้ไข
         async function saveEditedCustomer(oldShortName) {
            showLoadingOverlay('กำลังบันทึกข้อมูล...');
            try {
                const db = firebase.firestore();
                const batch = db.batch();

                // ดึงค่าจาก input fields
                const shortName = oldShortName; // ไม่อนุญาตให้แก้ไข shortName
                const fullName = document.getElementById('editFullName').value.trim();
                const type = document.getElementById('editType').value;
                const shift = document.getElementById('editShift').value;
                const calling = document.getElementById('editCalling').value.trim();

                if (!fullName || !type || !shift) {
                    showAlertModal('กรุณากรอกข้อมูลให้ครบถ้วน');
                    return;
                }

                // อัพเดท companyTypes
                const typeRef = db.collection('customerManagement').doc('companyTypes');
                const types = (await typeRef.get()).data() || {};
                types[shortName] = type;
                batch.set(typeRef, types);

                // อัพเดท companyGroups
                const groupRef = db.collection('customerManagement').doc('companyGroups');
                const groups = (await groupRef.get()).data() || { shifts: {} };

                // ลบ shortName จากทุก shift ก่อน
                Object.values(groups.shifts).forEach(companies => {
                    const index = companies.indexOf(shortName);
                    if (index !== -1) {
                        companies.splice(index, 1);
                    }
                });

                // เพิ่ม shortName ในกะใหม่
                if (!groups.shifts[shift]) {
                    groups.shifts[shift] = [];
                }
                if (!groups.shifts[shift].includes(shortName)) {
                    groups.shifts[shift].push(shortName);
                }
                batch.set(groupRef, groups);

                // อัพเดท mappings
                const mappingRef = db.collection('customerManagement').doc('companyMappings');
                const mappings = (await mappingRef.get()).data() || {};

                // ลบ mapping เก่า
                Object.entries(mappings).forEach(([key, value]) => {
                    if (value === shortName) {
                        delete mappings[key];
                    }
                });

                // เพิ่ม mapping ใหม่
                mappings[fullName] = shortName;
                batch.set(mappingRef, mappings);

                // อัพเดท callings
                if (calling) {
                    const callingsRef = db.collection('customerManagement').doc('companyFullNames');
                    const callings = (await callingsRef.get()).data() || {};
                    callings[shortName] = calling;
                    batch.set(callingsRef, callings);
                }

                // บันทึกการเปลี่ยนแปลงทั้งหมด
                await batch.commit();

                closeEditModal();
                loadAllCustomerInfo(); // โหลดข้อมูลใหม่
                 closeLoadingOverlay();
                showAlertModal('บันทึกข้อมูลสำเร็จ');

            } catch (error) {
                console.error('Error saving edited customer:', error);
                 closeLoadingOverlay();
                showAlertModal('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
            }
        }

        // ฟังก์ชันค้นหาข้อมูลลูกค้า
        function searchAllCustomerInfo(searchText) {
            const rows = document.querySelectorAll('#allCustomerInfo tr');
            searchText = searchText.toLowerCase();

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchText) ? '' : 'none';
            });
        }

        const originalShowTab = window.showTab;
        window.showTab = function (tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.getElementById(tabName).style.display = 'block';

            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            if (tabName === 'shifts') {
                loadShiftData();
            } else if (tabName === 'mappings') {
                loadMappingData();
            } else if (tabName === 'callings') {
                loadCallingData();
            } else if (tabName === 'allInfo') {
                loadAllCustomerInfo();
            }
        };

        // แก้ไขการเรียกชื่อ
        async function editCalling(shortName, currentCalling) {
      const mappingsDoc = await firebase.firestore().collection('customerManagement').doc('companyMappings').get();
       const mappings = mappingsDoc.exists ? mappingsDoc.data() : {};

    const modalHtml = `
      <div id="editCallingModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
          <h2 style="margin-bottom: 1.5rem; color: #2D2D2D;">แก้ไขรูปแบบการเรียกชื่อ</h2>
          <div class="form-group" style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">รหัสลูกค้า</label>
            <input type="text" id="editCallingShortName" value="${shortName}" class="form-control" readonly>
        </div>
         <div class="form-group" style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ชื่อลูกค้า</label>
            <input type="text" id="editCallingDisplayName" value="${mappings[shortName] || ''}" class="form-control" readonly>
        </div>
          <div class="form-group" style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">รูปแบบการเรียกชื่อ</label>
            <input type="text" id="editCallingPattern" value="${currentCalling}" class="form-control">
          </div>
          <div style="display: flex; justify-content: flex-end; gap: 1rem;">
            <button onclick="closeEditCallingModal()" class="btn" style="padding: 0.75rem 1.5rem;">ยกเลิก</button>
            <button onclick="saveEditedCalling('${shortName}')" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">บันทึก</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeEditCallingModal() {
    const modal = document.getElementById('editCallingModal');
    if (modal) {
        modal.remove();
    }
}

async function saveEditedCalling(shortName) {
     showLoadingOverlay('กำลังบันทึกข้อมูล...');
    try {
        const newCalling = document.getElementById('editCallingPattern').value.trim();
        if (newCalling) {
            const db = firebase.firestore();
            const callingsRef = db.collection('customerManagement').doc('companyFullNames');
    
                const doc = await callingsRef.get();
                const callings = doc.exists ? doc.data() : {};
    
                callings[shortName] = newCalling;
                await callingsRef.set(callings);
            closeEditCallingModal();
             loadCallingData();
             closeLoadingOverlay();
                showAlertModal('แก้ไขข้อมูลสำเร็จ');
        }
    } catch (error) {
        console.error('Error editing calling:', error);
        closeLoadingOverlay();
        showAlertModal('เกิดข้อผิดพลาดในการแก้ไขข้อมูล');
    }
}

        // ลบการเรียกชื่อ
        async function deleteCalling(shortName) {
            if (confirm('ต้องการลบการเรียกชื่อนี้ใช่หรือไม่?')) {
                try {
                    const db = firebase.firestore();
                    const callingsRef = db.collection('customerManagement').doc('companyFullNames');

                    const doc = await callingsRef.get();
                    const callings = doc.exists ? doc.data() : {};

                    delete callings[shortName];
                    await callingsRef.set(callings);

                    loadCallingData();
                    showAlertModal('ลบข้อมูลสำเร็จ');
                } catch (error) {
                    console.error('Error deleting calling:', error);
                     showAlertModal('เกิดข้อผิดพลาดในการลบข้อมูล');
                }
            }
        }

        // อัพเดต showTab function
       function showTab(tabName) {
          document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
          document.getElementById(tabName).style.display = 'block';

          document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
          event.target.classList.add('active');


            if (tabName === 'allInfo') {
                document.getElementById('loadingScreen').style.display = 'flex'; // Show loading
                document.getElementById('loadingMessage').textContent = 'กำลังโหลดข้อมูลลูกค้า...'; // Set loading message
                loadAllCustomerInfo().finally(() => { // Load data
                    document.getElementById('loadingScreen').style.display = 'none'; // Hide loading
                });
            } else if (tabName === 'mappings') {
                loadMappingData();
            } else if (tabName === 'callings') {
                loadCallingData();
            }
        }


        // ฟังก์ชันเพิ่มลูกค้าใหม่
        async function addCustomer() {
             showLoadingOverlay('กำลังเพิ่มลูกค้า...');
            try {
                const shortName = document.getElementById('customerName').value.trim();
                const fullName = document.getElementById('customerMapping').value.trim();
                const type = document.getElementById('customerType').value;
                const shift = document.getElementById('customerShift').value;

                if (!shortName || !fullName || !type || !shift) {
                    showAlertModal('กรุณากรอกข้อมูลให้ครบถ้วน');
                    return;
                }

                // เพิ่มข้อมูลทั้งหมดในครั้งเดียว
                const db = firebase.firestore();
                const batch = db.batch();

                // Update companyTypes
                const typeRef = db.collection('customerManagement').doc('companyTypes');
                const updatedTypes = {
                    ...companyTypes,
                    [shortName]: type
                };
                batch.set(typeRef, updatedTypes);

                // Update companyGroups
                const groupRef = db.collection('customerManagement').doc('companyGroups');
                const updatedGroups = { ...companyGroups };
                if (!updatedGroups[shift]) {
                    updatedGroups[shift] = [];
                }
                if (!updatedGroups[shift].includes(shortName)) {
                    updatedGroups[shift].push(shortName);
                }
                batch.set(groupRef, { shifts: updatedGroups });

                // Update mappings (สลับ key-value จากเดิม)
                const mappingRef = db.collection('customerManagement').doc('companyMappings');
                const mappings = (await mappingRef.get()).data() || {};
                mappings[fullName] = shortName;  // เปลี่ยนจาก shortName: fullName เป็น fullName: shortName
                batch.set(mappingRef, mappings);

                // Commit การเปลี่ยนแปลงทั้งหมดพร้อมกัน
                await batch.commit();

                // Update local data
                companyTypes = updatedTypes;
                companyGroups = updatedGroups;

                // Clear input fields
                document.getElementById('customerName').value = '';
                document.getElementById('customerMapping').value = '';

                // เอาออก
                //refreshCustomerList();
                 closeLoadingOverlay();
                showAlertModal('เพิ่มลูกค้าสำเร็จ');

            } catch (error) {
                console.error('Error adding customer:', error);
                 closeLoadingOverlay();
                showAlertModal('เกิดข้อผิดพลาดในการเพิ่มลูกค้า');
            }
        }
        async function deleteCustomer(companyName, shift) {
             if (!confirm(`ต้องการลบ ${companyName} ใช่หรือไม่?`)) {
                return;
            }
            showLoadingOverlay('กำลังลบลูกค้า...');
            try {
                // ลบจาก companyTypes
                const updatedTypes = { ...companyTypes };
                delete updatedTypes[companyName];
                await saveCustomerData('companyTypes', updatedTypes);
                companyTypes = updatedTypes;

                // ลบจาก companyGroups
                const updatedGroups = { ...companyGroups };
                if (updatedGroups[shift]) {
                    updatedGroups[shift] = updatedGroups[shift].filter(company => company !== companyName);
                }
                await saveCustomerData('companyGroups', { shifts: updatedGroups });
                companyGroups = updatedGroups;
                //เอาออก
                // refreshCustomerList();
                 closeLoadingOverlay();
                showAlertModal('ลบลูกค้าสำเร็จ');
            } catch (error) {
                console.error('Error deleting customer:', error);
                closeLoadingOverlay();
                showAlertModal('เกิดข้อผิดพลาดในการลบลูกค้า');
            }
        }
        // ฟังก์ชันเพิ่ม mapping
        async function addMapping() {
             showLoadingOverlay('กำลังเพิ่ม Mapping...');
            const displayName = document.getElementById('mappingDisplay').value.trim();
            const replaceName = document.getElementById('mappingReplace').value.trim();

            if (!displayName || !replaceName) {
                showAlertModal('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            try {
                const db = firebase.firestore();
                const mappingRef = db.collection('customerManagement').doc('companyMappings');
                const mappings = (await mappingRef.get()).data() || {};

                mappings[displayName] = replaceName;
                await mappingRef.set(mappings);

                // Clear input fields
                document.getElementById('mappingDisplay').value = '';
                document.getElementById('mappingReplace').value = '';

                // Reload mapping data
                 await loadMappingData();
                 closeLoadingOverlay();
                showAlertModal('เพิ่ม Mapping สำเร็จ');
            } catch (error) {
                console.error('Error adding mapping:', error);
                 closeLoadingOverlay();
                 showAlertModal('เกิดข้อผิดพลาดในการเพิ่ม Mapping');
            }
        }

        async function loadMappingData() {
            try {
                const db = firebase.firestore();
                const mappingDoc = await db.collection('customerManagement').doc('companyMappings').get();
                const mappings = mappingDoc.exists ? mappingDoc.data() : {};

                const mappingList = document.getElementById('mappingList');
                mappingList.innerHTML = '';

                // สร้าง table container with improved styling
                const tableContainer = document.createElement('div');
                tableContainer.style.overflowX = 'auto';
                tableContainer.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1)';
                tableContainer.style.borderRadius = '8px';

                // สร้างตาราง
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                table.style.backgroundColor = 'white';

                // สร้าง header ด้วย styling ที่ดีขึ้น
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr style="background-color: #f8f9fa;">
                        <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6; color: #495057; font-weight: 600;">
                            ชื่อที่แสดงในระบบ
                        </th>
                        <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6; color: #495057; font-weight: 600;">
                            ชื่อที่ใช้แทน
                        </th>
                        <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #dee2e6; color: #495057; font-weight: 600;">
                            การจัดการ
                        </th>
                    </tr>
                `;
                table.appendChild(thead);

                // สร้าง body ด้วย styling ที่ดีขึ้น
                const tbody = document.createElement('tbody');
                // เรียงข้อมูลตาม key (displayName)
                Object.entries(mappings)
                     .sort(( [displayNameA], [displayNameB]) => displayNameA.localeCompare(displayNameB))
                    .forEach(([displayName, replaceName]) => {
                    const tr = document.createElement('tr');
                    tr.style.transition = 'background-color 0.3s ease';
                    tr.onmouseenter = () => tr.style.backgroundColor = '#f8f9fa';
                    tr.onmouseleave = () => tr.style.backgroundColor = 'white';
                    tr.innerHTML = `
                        <td style="padding: 1rem; border-bottom: 1px solid #dee2e6;">${displayName}</td>
                        <td style="padding: 1rem; border-bottom: 1px solid #dee2e6;">${replaceName}</td>
                        <td style="padding: 1rem; border-bottom: 1px solid #dee2e6; text-align: center;">
                            <button onclick="editMapping('${displayName}', '${replaceName}')" 
                                    class="btn btn-primary" 
                                    style="margin-right: 0.5rem; padding: 0.5rem 1rem;">แก้ไข</button>
                            <button onclick="deleteMapping('${displayName}')" 
                                    class="btn btn-danger" 
                                    style="padding: 0.5rem 1rem;">ลบ</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);

                tableContainer.appendChild(table);
                mappingList.appendChild(tableContainer);

            } catch (error) {
                console.error('Error loading mappings:', error);
                mappingList.innerHTML = '<p style="color: red;">เกิดข้อผิดพลาดในการโหลดข้อมูล Mapping</p>';
            }
        }
        
        // โหลดข้อมูลการเรียกชื่อลูกค้า
        async function loadCallingData() {
            try {
                const db = firebase.firestore();

                // โหลดข้อมูลลูกค้าทั้งหมด
                const mappingsDoc = await db.collection('customerManagement').doc('companyMappings').get();
                const mappings = mappingsDoc.exists ? mappingsDoc.data() : {};

                // โหลดข้อมูลการเรียกชื่อที่มีอยู่
                const callingsDoc = await db.collection('customerManagement').doc('companyFullNames').get();
                const callings = callingsDoc.exists ? callingsDoc.data() : {};

                // อัพเดต dropdown ลูกค้า
                const customerSelect = document.getElementById('customerSelect');
                customerSelect.innerHTML = '<option value="">-- เลือกลูกค้า --</option>';

                Object.entries(mappings).forEach(([fullName, shortName]) => {
                    const option = document.createElement('option');
                    option.value = shortName;
                    option.textContent = `${shortName} (${fullName})`;
                    customerSelect.appendChild(option);
                });

                // แสดงรายการการเรียกชื่อทั้งหมด
                const callingList = document.getElementById('callingList');
                callingList.innerHTML = '';

                 const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';

                // สร้างส่วนหัวตาราง
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr style="background-color: #f8f9fa;">
                        <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6;">รหัสลูกค้า</th>
                         <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6;"></th>
                        <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #dee2e6;">การเรียกชื่อ</th>
                        <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #dee2e6;">จัดการ</th>
                    </tr>
                `;
                table.appendChild(thead);

                // สร้างส่วนเนื้อหาตาราง
                const tbody = document.createElement('tbody');
                
                 // เรียงข้อมูลตาม key (shortName)
                Object.entries(callings)
                     .sort(([shortNameA], [shortNameB]) => shortNameA.localeCompare(shortNameB))
                    .forEach(([shortName, calling]) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                         <td style="padding: 1rem; border-bottom: 1px solid #dee2e6;">${shortName}</td>
                        <td style="padding: 1rem; border-bottom: 1px solid #dee2e6;">${mappings[shortName] || ''}</td>
                        <td style="padding: 1rem; border-bottom: 1px solid #dee2e6;">${calling}</td>
                         <td style="padding: 1rem; border-bottom: 1px solid #dee2e6; text-align: center;">
                            <button onclick="editCalling('${shortName}', '${calling}')" class="btn btn-primary" style="margin-right: 0.5rem;">แก้ไข</button>
                            <button onclick="deleteCalling('${shortName}')" class="btn btn-danger">ลบ</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                callingList.appendChild(table);

            } catch (error) {
                console.error('Error loading calling data:', error);
                 showAlertModal('เกิดข้อผิดพลาดในการโหลดข้อมูล');
            }
        }

        async function handleBulkImport() {
           showLoadingOverlay('กำลังนำเข้าข้อมูล...');
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];

            if (!file) {
               closeLoadingOverlay();
                showAlertModal('กรุณาเลือกไฟล์ CSV');
                return;
            }

            try {
                const text = await file.text();
                const rows = text.split('\n').filter(row => row.trim());

                const db = firebase.firestore();
                const batch = db.batch();

                // เตรียมข้อมูลสำหรับการอัพเดทแบบ batch
                let updatedTypes = { ...companyTypes };
                let updatedGroups = { ...companyGroups };
                let mappings = {};

                // โหลด mappings ที่มีอยู่
                const mappingDoc = await db.collection('customerManagement').doc('companyMappings').get();
                if (mappingDoc.exists) {
                    mappings = mappingDoc.data();
                }

                // ประมวลผลแต่ละแถว
                for (let i = 1; i < rows.length; i++) {  // ข้าม header row
                    const [shortName, fullName, type, shift] = rows[i].split(',').map(item => item.trim());

                    if (!shortName || !fullName || !type || !shift) continue;

                    // อัพเดท companyTypes
                    updatedTypes[shortName] = type;

                    // อัพเดท companyGroups
                    if (!updatedGroups[shift]) {
                        updatedGroups[shift] = [];
                    }
                    if (!updatedGroups[shift].includes(shortName)) {
                        updatedGroups[shift].push(shortName);
                    }

                    // อัพเดท mappings
                    mappings[fullName] = shortName;
                }

                // บันทึกการเปลี่ยนแปลงทั้งหมด
                batch.set(db.collection('customerManagement').doc('companyTypes'), updatedTypes);
                batch.set(db.collection('customerManagement').doc('companyGroups'), { shifts: updatedGroups });
                batch.set(db.collection('customerManagement').doc('companyMappings'), mappings);

                await batch.commit();

                // อัพเดทข้อมูลในหน้าเว็บ
                companyTypes = updatedTypes;
                companyGroups = updatedGroups;
                // เอาออก
               // refreshCustomerList();
                closeLoadingOverlay();
                showAlertModal('นำเข้าข้อมูลสำเร็จ');
                fileInput.value = '';  // รีเซ็ต input file

            } catch (error) {
                console.error('Error importing data:', error);
                closeLoadingOverlay();
                showAlertModal('เกิดข้อผิดพลาดในการนำเข้าข้อมูล');
            }
        }

        async function editMapping(displayName, replaceName) {
      // สร้าง modal dialog สำหรับแก้ไขข้อมูล
            const modalHtml = `
        <div id="editMappingModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
            <div style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h2 style="margin-bottom: 1.5rem; color: #2D2D2D;">แก้ไข Mapping</h2>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ชื่อที่แสดงในระบบ</label>
                    <input type="text" id="editMappingDisplayName" value="${displayName}" class="form-control" >
                </div>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ชื่อที่ใช้แทน</label>
                    <input type="text" id="editMappingReplaceName" value="${replaceName}" class="form-control">
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <button onclick="closeEditMappingModal()" class="btn" style="padding: 0.75rem 1.5rem;">ยกเลิก</button>
                    <button onclick="saveEditedMapping('${displayName}')" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">บันทึก</button>
                </div>
            </div>
        </div>
    `;

            // เพิ่ม modal เข้าไปใน DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// ฟังก์ชันปิด modal
function closeEditMappingModal() {
      const modal = document.getElementById('editMappingModal');
      if (modal) {
          modal.remove();
      }
    }

    async function saveEditedMapping(oldDisplayName) {
             showLoadingOverlay('กำลังบันทึก Mapping...');
            try {
                  const newDisplayName = document.getElementById('editMappingDisplayName').value.trim();
                  const newReplaceName = document.getElementById('editMappingReplaceName').value.trim();
                  
                  if (!newDisplayName || !newReplaceName) {
                      showAlertModal('กรุณากรอกข้อมูลให้ครบถ้วน');
                      return;
                  }

                 const db = firebase.firestore();
                const mappingRef = db.collection('customerManagement').doc('companyMappings');
                const mappings = (await mappingRef.get()).data() || {};

                // ลบค่าเดิมและเพิ่มค่าที่แก้ไขใหม่
                    delete mappings[oldDisplayName];
                  mappings[newDisplayName] = newReplaceName;
                  
                    await mappingRef.set(mappings);
                
                  closeEditMappingModal();
                   loadMappingData();
                   closeLoadingOverlay();
                    showAlertModal('แก้ไข Mapping สำเร็จ');
               
            }catch(error) {
                console.error('Error editing mapping:', error);
                closeLoadingOverlay();
                 showAlertModal('เกิดข้อผิดพลาดในการแก้ไข Mapping');
            }
    }

         async function deleteMapping(displayName) {
             if (confirm(`ต้องการลบ Mapping ของ ${displayName} ใช่หรือไม่?`)) {
                try {
                    const db = firebase.firestore();
                    const mappingRef = db.collection('customerManagement').doc('companyMappings');
                    const mappings = (await mappingRef.get()).data() || {};

                    delete mappings[displayName];
                    await mappingRef.set(mappings);
                     showAlertModal('ลบ Mapping สำเร็จ');
                    loadMappingData(); // โหลดข้อมูลใหม่
                } catch (error) {
                    console.error('Error deleting mapping:', error);
                     showAlertModal('เกิดข้อผิดพลาดในการลบ Mapping');
                }
             }
         }

        // ฟังก์ชัน logout
        function logout() {
            firebase.auth().signOut()
                .then(() => window.location.href = 'login.html')
                .catch(error => console.error('Logout error:', error));
        }

        // อัปเดตข้อมูลผู้ใช้เมื่อโหลดหน้า
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                await loadCustomerData();
                try {
                    const userDoc = await firebase.firestore()
                        .collection('users')
                        .doc(user.uid)
                        .get();

                    const importSection = `
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; color: #2D2D2D;">นำเข้าข้อมูลลูกค้าแบบกลุ่ม (Bulk Import)</h2>
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 0.5rem;">อัพโหลดไฟล์ CSV</label>
                    <input type="file" accept=".csv" class="form-control" id="csvFileInput" style="padding: 0.75rem;">
                </div>
                <button class="btn btn-primary" onclick="handleBulkImport()" style="margin-top: 1rem; padding: 0.75rem 2rem; font-weight: 600;">นำเข้าข้อมูล</button>
                <div style="margin-top: 1rem;">
                    <small style="color: #666;">
                        รูปแบบ CSV: shortName,fullName,type,shift<br>
                        ตัวอย่าง: BLA,บริษัท กรุงเทพประกันชีวิต จำกัด (มหาชน),company,Shift 1
                    </small>
                </div>
            </div>`;

                    // เพิ่ม import section เข้าไปใน DOM
                    const customersTab = document.getElementById('customers');
                    if (customersTab) {
                        customersTab.insertAdjacentHTML('afterbegin', importSection);
                    }


                    const userData = userDoc.data();
                    const displayElement = document.getElementById('userDisplayName');

                    if (userData?.displayName) {
                        displayElement.textContent = userData.displayName;
                    } else {
                        displayElement.textContent = user.email;
                    }
                    // Trigger initial load and show allInfo
                    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
                    document.getElementById('allInfo').style.display = 'block';
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelector('.tab[onclick="showTab(\'allInfo\')"]').classList.add('active');
                   
                     document.getElementById('loadingScreen').style.display = 'flex';
                     document.getElementById('loadingMessage').textContent = 'กำลังโหลดข้อมูลลูกค้า...';
                    loadAllCustomerInfo().finally(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                    });
                     document.getElementById('mainContent').style.display = 'block';
                } catch (error) {
                    console.error('Error fetching user data:', error);
                }
            } else {
                window.location.href = 'login.html';
            }
        });
    </script>
    <script src="auth.js"></script>
</body>

</html>